# XMTP Worldstore Agent

> **The AI shopping assistant that speaks crypto.** Natural language Amazon orders, USDC payments, zero blockchain headaches.

This is the conversational brain of the Worldstore system

## Setup

### Prerequisites
- **Node.js 20+** (`node --version`)
- **PNPM** (`npm install -g pnpm`)
- **Anthropic API key** (console.anthropic.com)
- **SerpAPI key** (optional, for product search)
- **Running x402 server** (see `/server` directory)

### Environment Configuration

```bash
# Copy and configure environment
cp .env.template .env

# Generate XMTP keys (creates WALLET_KEY and ENCRYPTION_KEY)
pnpm gen:keys
```

**Required Environment Variables:**

```bash
# AI Configuration
ANTHROPIC_API_KEY=sk-ant-your-key-here

# XMTP Protocol (generated by `pnpm gen:keys`)
WALLET_KEY=0x1234abcd...  # Private key for XMTP client
ENCRYPTION_KEY=your-32-byte-hex-key  # Encryption key for XMTP
XMTP_ENV=dev  # or production

# Backend Integration
WORLDSTORE_API_URL=http://localhost:3000  # Your x402 server

# User Wallet Management
WALLET_PRIVATE_KEY=0x...  # For generating user deterministic wallets
RPC_PROVIDER_URL=https://...

# Redis (recommended for production)
REDIS_URL=redis://localhost:6379

# Optional: Enhanced Features
SERPAPI_API_KEY=your-serpapi-key  # Better product search
DEBUG_AGENT=false  # Detailed logging
```

### Installation & Startup

```bash
# Install dependencies (from agent directory)
pnpm install

# Start Redis (recommended for production)
docker run -d --name redis-stack -p 6379:6379 redis/redis-stack:latest

# Start the agent
pnpm dev  # Development with hot reload
pnpm start  # Production mode
```

### Verify Setup
```bash
# Check that XMTP keys are generated
ls -la | grep .env  # Should see .env file

# Verify Redis connection
redis-cli ping  # Should return PONG

# Agent startup logs should show:
# ‚úì XMTP Client connected
# ‚úì Redis connected (or filesystem fallback)
# ‚úì Agent listening for messages
```

**The agent automatically:**
- Connects to XMTP network using your generated keys
- Initializes storage (Redis preferred, filesystem fallback)
- Migrates existing user data if upgrading storage
- Starts processing incoming messages

## User Interaction Patterns

### Profile Setup (First Time Users)
```
Agent: "Hi! I'm your crypto shopping assistant. To get started,
       I'll need your name, email, and shipping address."

User: "John Doe, john@example.com, 123 Main St, NYC"

Agent: "Perfect! Profile saved. Now you can shop with just
       'order headphones' or 'find a laptop under $1000'"
```

### Natural Language Shopping
```
User: "I need a wireless mouse for gaming"

Agent: "Found Logitech G Pro X Superlight for $149.99.
       25,600 DPI, 63g weight, great for competitive gaming.
       Order it?"

User: "Yes"

Agent: *checks USDC balance, processes payment*
```

### Funding Flow (When Balance is Low)
```
Agent: "You need $89.99 USDC but only have $23.45.
       What would you like to do?"

[üí∏ Add Funds Now] [‚ùå Cancel Order] [üí∞ Check Balance]

User: *taps "Add Funds Now"*

Agent: *sends wallet request for $66.54 USDC*
```

### Slash Commands for Power Users
- `/clear` - Reset conversation context (fresh start)
- `/menu` - Show main action menu with buttons
- `/help` - Display help and available commands
- `/delete` - delete self profile

## Technical Architecture

### AI Agent Framework
```
LangGraph Agent
‚îú‚îÄ‚îÄ Profile Management Tools
‚îÇ   ‚îú‚îÄ‚îÄ edit_profile()
‚îÇ   ‚îî‚îÄ‚îÄ read_profile()
‚îú‚îÄ‚îÄ Shopping Tools
‚îÇ   ‚îú‚îÄ‚îÄ search_product()
‚îÇ   ‚îî‚îÄ‚îÄ order_product()
‚îú‚îÄ‚îÄ Order Management Tools
‚îÇ   ‚îú‚îÄ‚îÄ get_user_order_history()
‚îÇ   ‚îî‚îÄ‚îÄ get_order_status()
‚îî‚îÄ‚îÄ GOAT SDK Tools
    ‚îú‚îÄ‚îÄ Wallet operations
    ‚îî‚îÄ‚îÄ USDC balance checking
```

### Payment Flow Deep Dive

1. **User Intent**: "Order this product"
2. **Product Lookup**: Agent queries x402 server for pricing
3. **Balance Check**: GOAT SDK checks user's USDC balance
4. **Payment Generation**: If sufficient funds, generates EIP-3009 signature
5. **Order Submission**: Sends signed payment to x402 server
6. **Fulfillment**: Server processes payment and places Amazon order
7. **Confirmation**: User gets order ID and tracking info


### Interactive Action Buttons

Instead of immediately sending wallet requests when funds are insufficient, the agent provides user-controlled options:

```typescript
// Enhanced UX with action buttons
const insufficientFundsResponse = {
  content: "You need $89.99 USDC but only have $23.45",
  actions: [
    { label: "üí∏ Add Funds Now", intent: "fund_wallet" },
    { label: "‚ùå Cancel Order", intent: "cancel_order" },
    { label: "üí∞ Check Balance", intent: "check_balance" }
  ]
}
```

## Development Workflow

```bash
# Development with hot reload
pnpm dev

# Production mode
pnpm start

# Run tests (if available)
pnpm test

# Check TypeScript
pnpm type:check

# Lint and format
pnpm lint
```


The agent works across multiple networks for maximum user flexibility:

| Network | USDC Contract | Status |
|---------|---------------|---------|
| **Base Mainnet** | `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913` | ‚úÖ Production |
| **Base Sepolia** | `0x036CbD53842c5426634e7929541eC2318f3dCF7e` | ‚úÖ Testnet |
| **Ethereum** | `0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48` | ‚úÖ Production |
| **Polygon** | `0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359` | ‚úÖ Production |
| **Arbitrum** | `0xaf88d065e77c8cC2239327C5EDb3A432268e5831` | ‚úÖ Production |

Users can specify network preference or let the agent choose the optimal one based on fees and availability.

This agent transforms crypto shopping from a technical exercise into a natural conversation. Your users will forget they're using blockchain technology, which is exactly the point.